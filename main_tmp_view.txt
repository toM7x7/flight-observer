import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { CONFIG } from './config.js';

const $ = s=>document.querySelector(s);
const c=$('#c'), latI=$('#lat'), lonI=$('#lon'), radI=$('#radius');
$('#fetchBtn').onclick=refresh; $('#toggleBtn').onclick=()=>toggleView(); $('#startAR').onclick=startAR;

const renderer=new THREE.WebGLRenderer({canvas:c,antialias:true,alpha:true});
renderer.setPixelRatio(devicePixelRatio); renderer.setSize(innerWidth,innerHeight); renderer.xr.enabled=true;
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,2000);
const grid=new THREE.GridHelper(1000,40,0x2a3a4d,0x1a2735); grid.position.y=-1; scene.add(grid);
scene.add(new THREE.HemisphereLight(0xffffff,0x223344,1.0));
const markers=new THREE.Group(); scene.add(markers);
addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});

// 譛譁ｰ縺ｮ繝輔Λ繧､繝育憾諷九ｒ菫晄戟・医メ繝｣繝・ヨ逕ｨ・・let lastStates = [];

// DOM overlay root 縺ｨ XR驕ｸ謚樊椛蛻ｶ
const overlayRoot = document.getElementById('overlay');
document.addEventListener('beforexrselect', (ev)=>{
  if (overlayRoot && overlayRoot.contains(ev.target)) ev.preventDefault();
});

// === DOM Overlay 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・育ｰ｡譏・D繝代ロ繝ｫ・峨→蜈･蜉帛捉繧・===
let fallbackPanel = null;         // THREE.Group
let fallbackPanelMesh = null;     // THREE.Mesh
const raycaster = new THREE.Raycaster();
const _tmpMat = new THREE.Matrix4();
let controller0 = null, controller1 = null;
let hitTestSource = null, viewerSpace = null; // 霆ｽ驥秋it Test・井ｻｻ諢擾ｼ・let haveHitPose = false; const lastHitPos = new THREE.Vector3();

function ensureControllers(session){
  if (controller0 && controller1) return;
  const onSelect = (e)=>{
    // 3D繝代ロ繝ｫ縺ｫ繝ｬ繧､縺悟ｽ薙◆縺｣縺溘ｉ驟咲ｽｮ・・it Test蜆ｪ蜈医√↑縺代ｌ縺ｰ繧ｫ繝｡繝ｩ蜑肴婿・・    if (!fallbackPanelMesh) return;
    const src = e.target; // controller object3D
    _tmpMat.identity().extractRotation(src.matrixWorld);
    const origin = new THREE.Vector3().setFromMatrixPosition(src.matrixWorld);
    const direction = new THREE.Vector3(0,0,-1).applyMatrix4(_tmpMat).normalize();
    raycaster.set(origin, direction);
    const isects = raycaster.intersectObject(fallbackPanelMesh, true);
    if (isects.length>0){
      if (haveHitPose){
        markers.position.set(lastHitPos.x, lastHitPos.y, lastHitPos.z);
      } else {
        const camPos = new THREE.Vector3(); camera.getWorldPosition(camPos);
        const camDir = new THREE.Vector3(); camera.getWorldDirection(camDir);
        const target = camPos.add(camDir.multiplyScalar(2));
        markers.position.copy(target);
        markers.position.y = THREE.MathUtils.clamp(markers.position.y, -2, 5);
      }
    }
  };
  controller0 = renderer.xr.getController(0); controller0.addEventListener('select', onSelect); scene.add(controller0);
  controller1 = renderer.xr.getController(1); controller1.addEventListener('select', onSelect); scene.add(controller1);
}

function ensureFallbackUI(session){
  const type = session?.domOverlayState?.type; // 'head-locked' | 'floating' | 'screen' | undefined
  if (type) return; // DOM Overlay 縺悟柑縺冗腸蠅・↑繧峨ヵ繧ｩ繝ｼ繝ｫ繝舌ャ繧ｯ荳崎ｦ・  if (fallbackPanel) return;
  // 邁｡譏薙く繝｣繝ｳ繝舌せ縺ｧ隱ｬ譏弱→繝懊ち繝ｳ鬚ｨ繧呈緒縺・  const cvs = document.createElement('canvas'); cvs.width=1024; cvs.height=512; const ctx=cvs.getContext('2d');
  ctx.fillStyle='#0f141a'; ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle='#cde3ff'; ctx.font='bold 48px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('AR UI Fallback: Panel', 512, 120);
  ctx.font='32px system-ui';
  ctx.fillText('Trigger on panel to place markers (hit-test if available).', 512, 200);
  ctx.fillStyle='#1e88ff'; ctx.fillRect(362, 300, 300, 100);
  ctx.fillStyle='#ffffff'; ctx.font='bold 40px system-ui'; ctx.fillText('Place Here', 512, 350);
  const tex = new THREE.CanvasTexture(cvs); tex.anisotropy = 8;
  const mat = new THREE.MeshBasicMaterial({ map: tex, transparent:true, side: THREE.DoubleSide });
  const geo = new THREE.PlaneGeometry(0.8, 0.4);
  fallbackPanelMesh = new THREE.Mesh(geo, mat);
  fallbackPanel = new THREE.Group();
  fallbackPanel.add(fallbackPanelMesh); scene.add(fallbackPanel);
}

// === 繝励Μ繧ｻ繝・ヨ ===
const PRESETS_DEFAULT = [
  { name:'鄒ｽ逕ｰT1螻墓悍',     lat:35.553972, lon:139.779978, radius:30 },
  { name:'謌千伐B蜊礼ｫｯ',      lat:35.757589, lon:140.383137, radius:30 },
  { name:'莨贋ｸｹ 蜊・㈹蟾・,    lat:34.777094, lon:135.438095, radius:20 },
  { name:'驍｣隕・轢ｬ髟ｷ蟲ｶ',    lat:26.183469, lon:127.646278, radius:25 },
  { name:'荳ｭ驛ｨ 繧ｻ繝ｳ繝医Ξ繧｢', lat:34.858333, lon:136.805278, radius:30 }
];
const PRESET_KEY='flightObserver.presets';
function getPresets(){ return JSON.parse(localStorage.getItem(PRESET_KEY)||'[]').concat(PRESETS_DEFAULT); }
function renderPresetSelect(){
  const sel = document.getElementById('preset'); if(!sel) return; sel.innerHTML='';
  getPresets().forEach((p,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=p.name; sel.appendChild(o); });
}
function applyPreset(idx){
  const p = getPresets()[idx]; if(!p) return;
  document.getElementById('lat').value = String(p.lat);
  document.getElementById('lon').value = String(p.lon);
  document.getElementById('radius').value = String(p.radius);
  refresh();
}
document.getElementById('preset')?.addEventListener('change', e=>applyPreset(e.target.value));
document.getElementById('savePreset')?.addEventListener('click', ()=>{
  const mine = JSON.parse(localStorage.getItem(PRESET_KEY)||'[]');
  mine.unshift({ name:`My蝨ｰ轤ｹ ${new Date().toLocaleString()}`, lat:Number(latI.value), lon:Number(lonI.value), radius:Number(radI.value) });
  localStorage.setItem(PRESET_KEY, JSON.stringify(mine.slice(0,20))); // 荳企剞20莉ｶ
  renderPresetSelect();
});
renderPresetSelect();

// === 繝槭・繧ｫ繝ｼ/繝ｩ繝吶Ν ===
function makeMarker({callsign,hdg}){ const g=new THREE.ConeGeometry(3,8,12), m=new THREE.MeshStandardMaterial({color:0xffc83d});
  const mesh=new THREE.Mesh(g,m); mesh.rotation.x=-Math.PI/2; const label=makeLabel(callsign||'N/A'); label.position.set(0,5,0); mesh.add(label);
  const yaw=THREE.MathUtils.degToRad(hdg||0); mesh.rotation.z=-yaw; return mesh; }
function makeLabel(text){ const cv=document.createElement('canvas'), s=256; cv.width=cv.height=s; const ctx=cv.getContext('2d');
  ctx.fillStyle='#0f141a';ctx.fillRect(0,0,s,s);ctx.fillStyle='#cde3ff';ctx.font='bold 46px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,s/2,s/2);
  const tex=new THREE.CanvasTexture(cv); tex.anisotropy=8; const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true})); sp.scale.set(16,8,1); return sp; }

let useAR=false; function toggleView(){grid.visible=!grid.visible}
async function startAR(){
  try {
    const ok = await navigator.xr?.isSessionSupported?.('immersive-ar');
    if (ok === false) { alert('immersive-ar譛ｪ蟇ｾ蠢懊・迺ｰ蠅・〒縺・); return; }
    if (!navigator.xr) { alert('WebXR譛ｪ蟇ｾ蠢懊・繝悶Λ繧ｦ繧ｶ縺ｧ縺・); return; }
    const opts = {
      requiredFeatures: [],
      optionalFeatures: ['dom-overlay','hand-tracking','local-floor','hit-test'],
      domOverlay: { root: overlayRoot }
    };
    renderer.xr.setReferenceSpaceType('local-floor');
    const session = await navigator.xr.requestSession('immersive-ar', opts);
    await renderer.xr.setSession(session);

    // 霆ｽ驥秋it Test・亥ｯｾ蠢懈凾縺ｮ縺ｿ・・    try {
      if (session.requestReferenceSpace && session.requestHitTestSource) {
        viewerSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
      }
    } catch (e) { console.warn('Hit Test unavailable', e); }

    // DOM overlay 縺檎┌縺・腸蠅・・繝輔か繝ｼ繝ｫ繝舌ャ繧ｯUI・育ｰ｡譏・D繝代ロ繝ｫ・・    ensureFallbackUI(session);
    ensureControllers(session);

    console.log('domOverlayState=', session.domOverlayState?.type, 'isPresenting=', renderer.xr.isPresenting);

    // 繧ｳ繝ｳ繝医Ο繝ｼ繝ｩ squeeze 縺ｧ諡｡邵ｮ・亥承=諡｡螟ｧ縲∝ｷｦ=邵ｮ蟆擾ｼ・    session.addEventListener('squeeze', (e)=>{
      const sign = e.inputSource?.handedness === 'right' ? 1 : -1;
      const s = THREE.MathUtils.clamp(markers.scale.x * (1 + 0.1*sign), 0.1, 10);
      markers.scale.setScalar(s);
    });

    useAR = true;
    animateWithHands(session);

    session.addEventListener('end', ()=>{
      if (fallbackPanel) { scene.remove(fallbackPanel); fallbackPanel=null; fallbackPanelMesh=null; }
      controller0=null; controller1=null; hitTestSource=null; viewerSpace=null; haveHitPose=false;
    });
  } catch (e) {
    console.error('startAR failed', e);
    alert('AR髢句ｧ九↓螟ｱ謨・ '+(e?.message||e));
  }
}

function animate(){ renderer.setAnimationLoop(()=>renderer.render(scene,camera)); }

function llDiffMeters(lat0,lon0,lat,lon){ const Rlat=111132, Rlon=111320*Math.cos(lat0*Math.PI/180);
  return { x:(lon-lon0)*Rlon, y:(lat-lat0)*Rlat }; }

function placeMarkers(center,flights){ markers.clear(); flights.forEach(f=>{ const {x,y}=llDiffMeters(center.lat,center.lon,f.lat,f.lon);
  const m=makeMarker(f); m.position.set(x/10,0,y/10); markers.add(m); }); }

async function refresh(){
  const lat=Number(latI.value), lon=Number(lonI.value), radius=Number(radI.value||30);
  const url=`${CONFIG.FLIGHT_ENDPOINT}?lat=${lat}&lon=${lon}&radius_km=${radius}`;
  try{ const r=await fetch(url); if(!r.ok) throw new Error(`${r.status}`); const j=await r.json();
    lastStates = j.states || [];
    $('#src').textContent=`source: opensky | flights: ${lastStates.length}`; placeMarkers({lat,lon},lastStates); renderList(lastStates); if(!useAR) animate();
  }catch(e){ console.error('fetch failed',e); alert('蜿門ｾ励↓螟ｱ謨・ '+(e?.message||e)); }
}

function renderList(states){
  const box=$('#list'); box.innerHTML='<h3>繝輔Λ繧､繝井ｸ隕ｧ</h3>'+states.map((s,i)=>`<div class=\"item\" data-idx=\"${i}\"><span>${s.callsign||'(unknown)'}</span><span>#${i+1}</span></div>`).join('');
  box.querySelectorAll('.item').forEach(el=>el.addEventListener('click',async()=>{
    const s=states[Number(el.getAttribute('data-idx'))]; const flight={callsign:s.callsign,alt_m:s.geo_alt??s.baro_alt??0,vel_ms:s.vel??0,hdg_deg:s.hdg??0,lat:s.lat,lon:s.lon};
    // 1) Gemini隕∫せ
    const g=await fetch('/api/describe-flight',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({flight})});
    const {text}=await g.json();
    // 2) Aivis隱ｭ縺ｿ荳翫￡
    const t=await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,model_uuid:CONFIG.AIVIS_MODEL_UUID,use_ssml:true})});
    const buf=await t.arrayBuffer(); new Audio(URL.createObjectURL(new Blob([buf],{type:'audio/mpeg'}))).play();
  }));
}
refresh();

// === ARﾃ輸I蟇ｾ隧ｱ: 繝√Ε繝・ヨ騾∽ｿ｡・・OM Overlay・・===
const askBtn = document.getElementById('ask');
if (askBtn) askBtn.onclick = async ()=>{
  const qEl = document.getElementById('q');
  const speakEl = document.getElementById('speak');
  const q = (qEl?.value||'').trim();
  if (!q) { appendLog('雉ｪ蝠上ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞'); return; }
  const first = document.querySelector('#list .item');
  const idx = first ? Number(first.getAttribute('data-idx')||0) : 0;
  const s = lastStates[idx];
  if (!s) { appendLog('繝輔Λ繧､繝医′譛ｪ驕ｸ謚・譛ｪ蜿門ｾ励〒縺・); return; }
  const flight = { callsign:s.callsign, alt_m:s.geo_alt??s.baro_alt??0, vel_ms:s.vel??0, hdg_deg:s.hdg??0, lat:s.lat, lon:s.lon };
  try {
    const g = await fetch('/api/describe-flight',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ flight, question:q })});
    const { text } = await g.json();
    appendLog(text||'(no response)');
    if (speakEl?.checked && text) {
      const t = await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ text, model_uuid: CONFIG.AIVIS_MODEL_UUID, use_ssml:true })});
      const buf = await t.arrayBuffer(); new Audio(URL.createObjectURL(new Blob([buf],{type:'audio/mpeg'}))).play();
    }
  } catch (e) {
    console.error('ask failed', e);
    appendLog('繧ｨ繝ｩ繝ｼ: '+(e?.message||e));
  }
};

function appendLog(m){ const el=document.getElementById('log'); if(!el) return; el.innerHTML += `<div>${m}</div>`; el.scrollTop=el.scrollHeight; }

// === 繝上Φ繝峨ヨ繝ｩ繝・く繝ｳ繧ｰ: 迚・焔繝斐Φ繝・荳贋ｸ・ 荳｡謇九ヴ繝ｳ繝・諡｡邵ｮ ===
let oneHand = { active:false, startY:0, baseY:0 };
let twoHands = { active:false, startDist:0, baseScale:1 };

function animateWithHands(session){
  const refSpace = renderer.xr.getReferenceSpace();
  renderer.setAnimationLoop((t, frame)=>{
    if (frame) {
      // Hit Test 譖ｴ譁ｰ・亥ｯｾ蠢懈凾・・      if (hitTestSource) {
        const results = frame.getHitTestResults(hitTestSource) || [];
        if (results.length>0) {
          const pose = results[0].getPose(refSpace);
          if (pose){
            const p = pose.transform.position; lastHitPos.set(p.x,p.y,p.z); haveHitPose=true;
          }
        } else { haveHitPose=false; }
      }
      const hands = {};
      for (const src of session.inputSources){
        if (!src.hand) continue;
        const h = src.handedness; // 'left' | 'right'
        const tip = src.hand.get('index-finger-tip');
        const thumb = src.hand.get('thumb-tip');
        const jt = tip && frame.getJointPose(tip, refSpace);
        const jb = thumb && frame.getJointPose(thumb, refSpace);
        if(!jt || !jb) continue;
        const dx = jt.transform.position.x - jb.transform.position.x;
        const dy = jt.transform.position.y - jb.transform.position.y;
        const dz = jt.transform.position.z - jb.transform.position.z;
        const dist = Math.hypot(dx,dy,dz);
        const pinching = dist < 0.025; // ~2.5cm 逶ｮ螳・        hands[h] = { pinching, y: jt.transform.position.y, x: jt.transform.position.x, z: jt.transform.position.z, tipPos: jt.transform.position };
      }

      // 迚・焔繝斐Φ繝・竊・荳贋ｸ狗ｧｻ蜍・      const leftP = !!hands.left?.pinching; const rightP = !!hands.right?.pinching;
      const which = leftP ^ rightP ? (leftP ? 'left' : 'right') : null;
      if (which){
        if(!oneHand.active){ oneHand={active:true,startY:hands[which].y,baseY:markers.position.y}; }
        const dy = hands[which].y - oneHand.startY;
        markers.position.y = THREE.MathUtils.clamp(oneHand.baseY + dy * 1.5, -2, 5);
      } else if (oneHand.active) {
        oneHand.active = false;
      }

      // 荳｡謇九ヴ繝ｳ繝・竊・諡｡邵ｮ
      if (hands.left?.pinching && hands.right?.pinching){
        const lx=hands.left.tipPos.x, ly=hands.left.tipPos.y, lz=hands.left.tipPos.z;
        const rx=hands.right.tipPos.x,ry=hands.right.tipPos.y,rz=hands.right.tipPos.z;
        const d = Math.hypot(lx-rx, ly-ry, lz-rz);
        if(!twoHands.active){ twoHands={active:true,startDist:d,baseScale:markers.scale.x}; }
        const f = THREE.MathUtils.clamp(d / (twoHands.startDist||d), 0.2, 5);
        markers.scale.setScalar(twoHands.baseScale * f);
      } else if (twoHands.active) {
        twoHands.active = false;
      }

      // 繧ｳ繝ｳ繝医Ο繝ｼ繝ｩ蜈･蜉幢ｼ医せ繝・ぅ繝・け荳贋ｸ九〒鬮伜ｺｦ・・      pollControllers(frame);
    }
    // DOM Overlay 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯUI繧帝ｭ縺ｫ霑ｽ蠕・    if (fallbackPanel){
      const camPos = new THREE.Vector3(); camera.getWorldPosition(camPos);
      const camDir = new THREE.Vector3(); camera.getWorldDirection(camDir);
      const pos = camPos.clone().add(camDir.multiplyScalar(0.9));
      fallbackPanel.position.copy(pos);
      fallbackPanel.lookAt(camPos);
    }
    renderer.render(scene,camera);
  });
}

function pollControllers(frame){
  const session = renderer.xr.getSession(); if(!session) return;
  for (const src of session.inputSources){
    const gp = src.gamepad; if(!gp) continue;
    const y = gp.axes?.[3];
    if (typeof y === 'number' && Math.abs(y)>0.2) {
      markers.position.y = THREE.MathUtils.clamp(markers.position.y + (-y)*0.02, -2, 5);
    }
  }
}
